<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="SevenTwo's Devlog">
  <meta property="og:type" content="website">
  <meta property="og:description" content="글보다는 그림으로 표현하는 주니어 개발자의 블로그">
  <meta property="og:image" content="/assets/images/seventwo_logo.png">
  <meta property="og:url" content="https://jiyong1.github.io">
  <title>[django] Auth</title>
  <link rel="icon" href="/assets/images/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/mdpost.css">
  <script src="https://kit.fontawesome.com/63e1d65e2b.js" crossorigin="anonymous"></script>
</head>
<body>
  <script src="/assets/script/mode_init.js"></script>
  
<nav class="top-nav">
  <div class="logo-con">
    <img src="/assets/images/seventwo_logo.png" alt="seventwo 로고 이미지" class="logo-img">
  </div>
  <div class="b-name"><a href="/">SevenTwo</a></div>
  <div class="toggle-btn">
    <span class="bar"></span>
    <span class="bar"></span>
    <span class="bar"></span>
  </div>
  <div class="nav-list">
    <ul>
      
        <li class="nav-items">
          <a href="/" class="item other-link ">
            Home
          </a>
        </li>
      
        <li class="nav-items">
          <a href="/about/" class="item other-link ">
            About
          </a>
        </li>
      
        <li class="nav-items">
          <a href="/posts/" class="item other-link ">
            Posts
          </a>
        </li>
      
    </ul>
  </div>
  <nav class="mode-con">
  <div id="mode-btn">
    <div class="mode-icon sun">
        <i class="fas fa-sun"></i>
    </div>
    <div class="mode-icon moon">
      <i class="fas fa-moon"></i>
    </div>
    <!-- <div class="btn-circle"></div> -->
    <script>
      let btndiv = document.createElement('div');
      let scheme = localStorage.getItem('scheme');
      btndiv.dataset.mode = scheme;
      btndiv.classList.add('btn-circle');

      document.querySelector('#mode-btn').appendChild(btndiv);
    </script>
  </div>
</nav>
</nav>

  <div class="container nav-margin">
    
<h1 id="django-auth">[django] Auth</h1>

<p><br /></p>

<h2 id="accounts">Accounts</h2>

<blockquote>
  <p>app 이름이 반드시 accounts 일 필요는 없지만, 
<strong>auth 관련 기본 설정들이 accounts로 내부적으로 사용되고</strong> 있기 때문에 되도록 accounts로 명명 권장</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python manage.py startapp accounts
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># settings.py
</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'articles'</span><span class="p">,</span>
    <span class="s">'accounts'</span><span class="p">,</span>
<span class="p">...</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># myform/urls.py
</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'accounts.urls'</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s">'accounts'</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    
<span class="p">]</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<p><br /></p>

<p><strong>Authentication(인증)</strong></p>

<ul>
  <li>신원 확인</li>
  <li>자신이 누구라고 <strong>주장하는 사람의 신원을 확인</strong>하는 것</li>
</ul>

<p><br /></p>

<p><strong>Authorization(권한, 허가)</strong></p>

<ul>
  <li>권한 부여</li>
  <li>가고 싶은 곳으로 가도록 혹은 <strong>원하는 정보를 얻도록 허용</strong>하는 과정</li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h2 id="authentication-in-web-requests">Authentication in Web requests</h2>

<h3 id="login">Login</h3>

<ul>
  <li>로그인은 <strong><code class="language-plaintext highlighter-rouge">Session을 create 하는 것</code></strong>이다.</li>
</ul>

<p><br /></p>

<p><strong>AuthenticationForm</strong></p>

<blockquote>
  <p>user 로그인을 위한 form</p>

  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#django.contrib.auth.forms.AuthenticationForm</p>

  <p>https://github.com/django/django/blob/master/django/contrib/auth/forms.py#L173</p>
</blockquote>

<p><br /></p>

<p><strong>login()</strong></p>

<blockquote>
  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#authentication-in-web-requests</p>
</blockquote>

<ul>
  <li>
    <p>현재 세션에 연결하려는 인증 된 사용자가 있는 경우 <code class="language-plaintext highlighter-rouge">login()</code> 함수가 필요하다.</p>
  </li>
  <li>
    <p>django 의 session framework 를 통해 user 의 ID 를 세션에 저장한다.</p>
  </li>
  <li>
    <p>즉, 로그인을 한다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>  
<span class="n">path</span><span class="p">(</span><span class="s">'login/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">login</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'login'</span><span class="p">),</span>
</code></pre></div>    </div>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">AuthenticationForm</code> 은 왜 첫번째 인자가 request 인가? 
ModelForm이 아닌 Form 이기 때문.</p>
    </blockquote>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>  
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">login</span> <span class="k">as</span> <span class="n">auth_login</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">AuthenticationForm</span>
  
  
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">auth_login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">.</span><span class="n">get_user</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'accounts/login.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>login 함수 이름을 <code class="language-plaintext highlighter-rouge">auth_login</code> 으로 변경해서 사용하는 이유는 view 함수인 login 과의 충돌을 방지하기 위함이다.</p>

    <div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- accounts/login.html --&gt;</span>
  
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span>
  
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;h1&gt;</span>로그인<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div>    </div>
    <p>```</p>

    <ul>
      <li>로그인 후 브라우저와 DB에서 세션 확인</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>
    <p>로그인을 진행하면 현재 로그인이 되어 있는지 확인할 수가 없기 때문에, 템플릿에서 현재 로그인 유저 이름을 출력 해보자.</p>

    <div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- base.html --&gt;</span>
  
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Hello, <span class="cp">{{</span> <span class="nv">request.user</span> <span class="cp">}}</span><span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:login'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
    <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
  <span class="nt">&lt;/div&gt;</span>
  ...
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h3 id="logout">Logout</h3>

<blockquote>
  <p>로그아웃은 <strong>Session을 Delete</strong> 하는 로직과 같다.</p>
</blockquote>

<p><strong>logout()</strong></p>

<blockquote>
  <p>https://docs.djangoproject.com/ko/3.1/topics/auth/default/#how-to-log-a-user-out</p>
</blockquote>

<ul>
  <li>
    <p>logout 함수는 HttpRequest 객체를 인자로 받고 return 값은 없다.</p>
  </li>
  <li>
    <p>logout 함수를 호출하면 현재 request에 대한 db의 session data를 완전히 정리하고, 클라이언트 쿠키에서도 sessionid가 삭제된다.</p>
  </li>
  <li>
    <p>이는 다른 사람이 동일한 웹 브라우저를 사용하여 로그인하고, 이전 사용자의 세션 데이터에 액세스하는 것을 방지하기 위한 것이다.</p>
  </li>
  <li>
    <p>사용자가 로그인하지 않은 경우 오류를 발생시키지 않는다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>  
<span class="n">path</span><span class="p">(</span><span class="s">'logout/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">logout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'logout'</span><span class="p">),</span>
</code></pre></div>    </div>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>  
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">logout</span> <span class="k">as</span> <span class="n">auth_logout</span>
<span class="c1"># from django.contrib.auth import login as auth_login, logout as auth_logout 처럼 작성 가능
</span><span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>
  
  
<span class="o">@</span><span class="n">require_POST</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">auth_logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
</code></pre></div>    </div>

    <div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- base.html --&gt;</span>
  
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Hello, <span class="cp">{{</span> <span class="nv">user.username</span> <span class="cp">}}</span><span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:login'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:logout'</span> <span class="cp">%}</span><span class="s">"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
      <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Logout"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
  <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h2 id="로그인-사용자에-대한-접근-제한">로그인 사용자에 대한 접근 제한</h2>

<blockquote>
  <p>https://docs.djangoproject.com/ko/3.1/topics/auth/default/#limiting-access-to-logged-in-users</p>
</blockquote>

<p><br /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">is_authenticated</code> attribute
    <ul>
      <li>The raw way</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">login_required</code> decorator
    <ul>
      <li>As a shortcut</li>
    </ul>
  </li>
</ol>

<p><br /></p>

<h3 id="is_authenticated">is_authenticated</h3>

<blockquote>
  <p><strong>주의!</strong> 
이것은 권한(permission)과는 관련이 없으며 사용자가 활성화 상태(active)이거나 유효한 세션(valid session)을 가지고 있는지도 확인하지 않는다.</p>
</blockquote>

<blockquote>
  <p>https://docs.djangoproject.com/en/3.1/ref/contrib/auth/#attributes</p>

  <p>https://github.com/django/django/blob/master/django/contrib/auth/base_user.py#L90</p>
</blockquote>

<ul>
  <li>
    <p>사용자가 인증 되었는지 알 수 있는 방법</p>
  </li>
  <li>
    <p>User model 의 <code class="language-plaintext highlighter-rouge">속성(attributes)</code> 들 중 하나.</p>
  </li>
  <li>
    <p>User에 항상 <code class="language-plaintext highlighter-rouge">True</code>이며, AnonymousUser에 대해서만 항상 <code class="language-plaintext highlighter-rouge">False</code>이다.</p>

    <div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- base.html --&gt;</span>
  
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_authenticated</span> <span class="cp">%}</span>
  <span class="nt">&lt;h3&gt;</span>Hello, <span class="cp">{{</span> <span class="nv">user.username</span> <span class="cp">}}</span><span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:logout'</span> <span class="cp">%}</span><span class="s">"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Logout"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:login'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<p><strong>로그인 후 로그인 페이지 접근 제한</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>비 로그인시 게시글 작성 링크 가리기</strong></p>

<div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- articles/index.html --&gt;</span>

<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>Articles<span class="nt">&lt;/h1&gt;</span>
  <span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.is_authenticated</span> <span class="cp">%}</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'articles:create'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>CREATE<span class="nt">&lt;/a&gt;</span>
  <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{%</span> <span class="nv">url</span> <span class="s1">'accounts:login'</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>[새 글을 작성하려면 로그인하세요]<span class="nt">&lt;/a&gt;</span>
  <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
  ...
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>

<ul>
  <li>하지만 비 로그인 상태로도 url 에 직접 입력하면 작성 페이지로 갈 수 있다.</li>
</ul>

<p><br /></p>

<h3 id="login_required-decorator">login_required decorator</h3>

<blockquote>
  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#limiting-access-to-logged-in-users</p>

  <p>https://github.com/django/django/blob/master/django/contrib/auth/decorators.py#L38</p>
</blockquote>

<ul>
  <li>로그인 하지 않은 사용자의 경우 <code class="language-plaintext highlighter-rouge">settings.LOGIN_URL</code>에 설정된 문자열 기반 절대 경로로 리다이렉트 된다.
    <ul>
      <li>ex) 이후 인증 성공시 사용자가 redirect 되어야하는 경로는 <code class="language-plaintext highlighter-rouge">next</code>라는 쿼리 문자열 매개 변수에 저장</li>
    </ul>
  </li>
  <li>LOGIN_URL 의 기본 값은 <code class="language-plaintext highlighter-rouge">'/accounts/login/'</code>, 우리가 두번째 app 이름을 accounts 로 했던 이유 중 하나</li>
  <li>로그인 된 사용자의 경우 정상적으로 해당 view 를 실행한다.</li>
</ul>

<p><br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># articles/views.py
</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>


<span class="o">@</span><span class="n">login_required</span>
<span class="o">@</span><span class="n">require_http_methods</span><span class="p">([</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>


<span class="o">@</span><span class="n">login_required</span>
<span class="o">@</span><span class="n">require_http_methods</span><span class="p">([</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>


<span class="o">@</span><span class="n">login_required</span>
<span class="o">@</span><span class="n">require_POST</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
</code></pre></div></div>

<ul>
  <li>이제 <code class="language-plaintext highlighter-rouge">articles/create/</code> 로 강제 접속 시 로그인 페이지로 리다이렉트 된다.</li>
  <li>그런데 <code class="language-plaintext highlighter-rouge">/accounts/login/?next=/articles/create/</code> 와 같은 주소가 생성된다.</li>
</ul>

<p><br /></p>

<p><strong><code class="language-plaintext highlighter-rouge">"next"</code> query string parameter</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@login_required</code> 은 기본적으로 인증 성공 후 사용자를 리다이렉트 할 경로를 <strong>next 라는 문자열 매개 변수에 저장</strong>한다.</p>
  </li>
  <li>
    <p>우리가 url 로 접근하려고 했던 그 주소가 로그인이 되어있지 않으면 볼 수 없는 곳이라서, django 가 로그인 페이지로 강제로 돌려 보냈는데, 로그인을 다시 정상적으로 하면 원래 요청했던 주소로 보내 주기 위해 <strong>keep 해주는 것</strong>이다.</p>
  </li>
  <li>
    <p>따로 처리 해주지 않으면 우리가 view에 설정한 redirect 경로로 이동하지만, next 에 저장된 주소로 이동되도록 만들기 위해 작업을 해보자.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>  
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
  
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">auth_login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">.</span><span class="n">get_user</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">GET</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'next'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'articles:index'</span><span class="p">)</span>
  
<span class="p">...</span>
</code></pre></div>    </div>

    <blockquote>
      <p>[주의]</p>

      <ul>
        <li>
          <p>만약 <code class="language-plaintext highlighter-rouge">login.html</code>에서 form action이 작성되어 있다면 동작하지 않는다.</p>
        </li>
        <li>
          <p>해당 action 주소 자체가 next 파라미터가 붙어있는 현재 url이 아닌 <code class="language-plaintext highlighter-rouge">/accounts/login/</code> 으로 요청을 보내기 때문이다.</p>
        </li>
      </ul>
    </blockquote>
  </li>
</ul>

<p><br /></p>

<p><strong>두 데코레이터로 인해 로직상 문제 발생</strong></p>

<ul>
  <li>
    <p>비로그인 상태로 detail 페이지에서 글 삭제 시도해보자.</p>
  </li>
  <li>
    <p>만약 <code class="language-plaintext highlighter-rouge">@require_POST</code> 가 있는 함수에 <code class="language-plaintext highlighter-rouge">@login_required</code> 가 설정 된다면 로그인 이후 <code class="language-plaintext highlighter-rouge">"next"</code> 매개변수를 따라 해당 함수로 다시 redirect 되면서 <code class="language-plaintext highlighter-rouge">@require_POST</code> 때문에 405 에러가 발생하게 될 것이다.</p>
  </li>
  <li>
    <p>이 경우 두가지 문제가 발생하게 되는데 첫째로는 <strong>redirect 중 POST 데이터의 손실</strong>이 일어나며 둘째로는 애초에 <strong>redirect 는 POST Request 가 불가능</strong>하여 GET Request 로 요청이 보내진다.</p>
  </li>
  <li>
    <p>비로그인 상태 POST로 요청 -&gt; 로그인 검증(@login_required) -&gt; 로그인 페이지 (?next=’articles/1/delete/’) -&gt; 로그인 성공 -&gt; next로 redirect (GET Request) -&gt; POST인지 검증(@require_POST) -&gt; 405 Method Not Allowed</p>
  </li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">login_required</code> 는 GET 요청을 처리할 수 있는 View에서만 사용하자.</p>
</blockquote>

<ul>
  <li>
    <p>때문에 POST 요청만 허용하는 <code class="language-plaintext highlighter-rouge">delete</code> 와 같은 함수는 아래와 같이 함수 내부에서 처리하도록 한다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># articles/views.py
</span>  
<span class="o">@</span><span class="n">require_POST</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">article</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h2 id="회원-가입">회원 가입</h2>

<p><strong>UserCreationForm</strong></p>

<ul>
  <li>주어진 username과 password로 권한이 없는 user를 create하는 Modelform</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>
<span class="n">app_name</span> <span class="o">=</span> <span class="s">'accounts'</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'signup/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">signup</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'signup'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">AuthenticationForm</span><span class="p">,</span> <span class="n">UserCreationForm</span>


<span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'accounts/signup.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- accounts/signup.html --&gt;</span>

<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;h1&gt;</span>회원가입<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>회원가입 후 자동으로 로그인 상태 전환</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">auth_login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'accounts/signup.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="회원-탈퇴">회원 탈퇴</h2>

<blockquote>
  <p>유저를 탈퇴하는 것은 DB에서 유저를 삭제하는 것과 같음</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>
<span class="n">path</span><span class="p">(</span><span class="s">'delete/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">delete</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'delete'</span><span class="p">),</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>


<span class="o">@</span><span class="n">require_POST</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>sqlite 확장프로그램이나 admin 페이지에서 유저가 삭제 되었는지 확인해 본다.</li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h2 id="회원-수정">회원 수정</h2>

<p><strong>UserChangeForm</strong></p>

<blockquote>
  <p>user의 정보 및 권한을 변경하기 위해 admin 인터페이스에서 사용되는 modelform</p>

  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#django.contrib.auth.forms.UserChangeForm</p>

  <p>https://github.com/django/django/blob/master/django/contrib/auth/forms.py#L142</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>
<span class="n">path</span><span class="p">(</span><span class="s">'update/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">update</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'update'</span><span class="p">),</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/forms.py
</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">UserChangeForm</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>


<span class="k">class</span> <span class="nc">CustomUserChangeForm</span><span class="p">(</span><span class="n">UserChangeForm</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'email'</span><span class="p">,</span> <span class="s">'first_name'</span><span class="p">,</span> <span class="s">'last_name'</span><span class="p">,)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">CustomUserChangeForm</span>


<span class="o">@</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="c1"># form = CustomUserChangeForm(data=request.POST, instance=request.user)
</span>        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'accounts/update.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- accounts/update.html --&gt;</span>

<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;h1&gt;</span>회원정보수정<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span>  <span class="cp">%}</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- articles/base.html --&gt;</span>

{% if request.user.is_authenticated %}
  <span class="nt">&lt;h3&gt;</span>Hello, {{ user.username }}<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'accounts:update' %}"</span><span class="nt">&gt;</span>정보수정<span class="nt">&lt;/a&gt;</span>
  ...
{% else %}
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'accounts:login' %}"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{% url 'accounts:signup' %}"</span><span class="nt">&gt;</span>Signup<span class="nt">&lt;/a&gt;</span>
{% endif %}
</code></pre></div></div>

<ul>
  <li>정보수정 페이지를 확인해보자.</li>
</ul>

<p><br /></p>

<p><strong>get_user_model()</strong></p>

<blockquote>
  <p>https://docs.djangoproject.com/ko/3.1/topics/auth/customizing/#referencing-the-user-model</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">User</code>를 직접 참조하는 대신<code class="language-plaintext highlighter-rouge">django.contrib.auth.get_user_model()</code> 을 사용하여 User model 을 참조해야 한다.</li>
  <li><strong>이 함수는 현재 활성화(active)된 user model을 리턴</strong>한다.</li>
  <li>커스텀한 유저 모델이 있을 경우는 커스텀 유저 모델, 그렇지 않으면 User를 참조
    <ul>
      <li>단순 User를 직접 참조하지 않는 이유</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<p><strong>AbstractUser</strong></p>

<blockquote>
  <p>User model을 구현하는 완전한 기능을 갖춘 기본 클래스</p>
</blockquote>

<ul>
  <li>
    <p>django github 으로 가서 직접 <code class="language-plaintext highlighter-rouge">UserChangeForm</code> 을 확인해보자.</p>

    <ul>
      <li>https://github.com/django/django/blob/master/django/contrib/auth/forms.py#L132</li>
    </ul>
  </li>
  <li>
    <p>Meta 정보를 보면 User 라는 model 을 참조하는 ModelForm 이라는 것을 확인할 수 있다.</p>
  </li>
  <li>
    <p>이번엔 User 클래스를 찾아가보자.</p>

    <ul>
      <li>https://github.com/django/django/blob/master/django/contrib/auth/models.py#L384</li>
    </ul>
  </li>
  <li>
    <p>그런데 User 클래스는 비어있고 <code class="language-plaintext highlighter-rouge">AbstractUser</code> 를 상속받고 있다. AbstractUser 를 다시 따라가보자.</p>

    <ul>
      <li>https://github.com/django/django/blob/master/django/contrib/auth/models.py#L316</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">AbstractUser</code> 의 클래스 변수명들을 확인해보면 우리가 회원수정 페이지에서 봤던 필드들과 일치한다는 것을 할 수 있다.</p>
  </li>
  <li>
    <p>이제 공식문서에서 User 모델의 Fields 를 자세히 확인해보자.</p>

    <ul>
      <li>https://docs.djangoproject.com/en/3.1/ref/contrib/auth/#user-model</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<hr />

<p><br /></p>

<h2 id="비밀번호-변경">비밀번호 변경</h2>

<p><strong>PasswordChangeForm</strong></p>

<blockquote>
  <p>이전 비밀번호를 입력하여 비밀번호를 변경할 수 있도록 하는 Form</p>

  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#django.contrib.auth.forms.PasswordChangeForm</p>
</blockquote>

<ul>
  <li>
    <p>회원정보 수정을 위한 <code class="language-plaintext highlighter-rouge">UserChangeForm</code> 에도 password 필드는 있지만 막상 필드를 보면 수정할 수 없다.</p>
  </li>
  <li>
    <p>대신, 가장 하단에 ‘<strong>다만 이 양식으로 비밀번호를 변경할 수 없습니다.</strong>’ 라는 문구가 있는데, 이 링크를 클릭하면 <code class="language-plaintext highlighter-rouge">accounts/password/</code> 라는 주소로 이동한다. django가 기본적으로 설정하고 있는 주소이다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/urls.py
</span>  
<span class="n">path</span><span class="p">(</span><span class="s">'password/'</span><span class="p">,</span> <span class="n">views</span><span class="p">.</span><span class="n">change_password</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'change_password'</span><span class="p">),</span>
</code></pre></div>    </div>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># accounts/views.py
</span>  
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserCreationForm</span><span class="p">,</span>
    <span class="n">AuthenticationForm</span><span class="p">,</span>
    <span class="n">PasswordChangeForm</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">update_session_auth_hash</span>
  
  
<span class="o">@</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PasswordChangeForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">update_session_auth_hash</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'articles:index'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PasswordChangeForm</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'form'</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'accounts/change_password.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>    </div>

    <ul>
      <li><a href="https://github.com/django/django/blob/05bbff82638731a6abfed2fe0ae06a4d429cb32f/django/contrib/auth/forms.py#L316">SetPasswordForm</a>의 init 함수를 살펴보면 첫번째 인자로 반드시 user가 위치</li>
    </ul>

    <div class="language-django highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- accounts/change_password.html --&gt;</span>
  
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span>
  
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;h1&gt;</span>비밀번호 변경<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
  <span class="cp">{%</span> <span class="nv">csrf_token</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<p><strong>update_session_auth_hash()</strong></p>

<blockquote>
  <p>“암호 변경 시 세션 무효화 방지”</p>

  <ul>
    <li>비밀번호는 잘 변경되었으나 비밀번호가 변경 되면서 기존 세션과의 회원 인증 정보가 일치하지 않기 때문</li>
    <li>비밀번호는 잘 변경되었으나 비밀번호가 변경 되면서 기존 세션과의 회원 인증 정보가 일치하지 않기 때문</li>
    <li>현재 요청(current request)과 새 session hash가 파생 될 업데이트 된 사용자 객체를 가져와서 session hash를 적절하게 업데이트해 로그아웃을 막는다.</li>
  </ul>

  <p>https://docs.djangoproject.com/en/3.1/topics/auth/default/#session-invalidation-on-password-change</p>
</blockquote>

<p><br /></p>

<hr />


    <div class="post-list-box">
  
  
  
    
  
    
  
    
      
      
      
      
      
  <a href="/django/" class="list-btn">카테고리 목록으로</a>
  <div class="pn-btn-con">
    
      <a class="prev-btn pn-btn" href="/django/2021/03/19/djangostatic/">
        <div class="btn-icon">
          <i class="far fa-arrow-alt-circle-left"></i>
        </div>
        <div class="btn-text">
          <p class="small">이전 페이지</p>
          <p>[django] Static files</p>
        </div>
      </a>
    
    
      <a class="next-btn pn-btn" href="/django/2021/03/25/modelrelationship/">
        <div class="btn-text">
          <p class="small">다음 페이지</p>
          <p>[django] Model Relationship</p>
        </div>
        <div class="btn-icon">
          <i class="far fa-arrow-alt-circle-right"></i>
        </div>
      </a>
    
  </div>
    
</div>
  </div>
  <button class="up-arrow">
  <i class="fas fa-arrow-up"></i>
</button>
  <script src="/assets/script/nav.js"></script>
  <script src="/assets/script/mode.js"></script>
  <script src="/assets/script/up.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
</body>
</html>